#/bin/bash
set -euo pipefail

TAG=${1:-}
ROOT=$PWD
VERSIONS="0.9.3 0.9.4 0.9.5"

mkdir -p releases
git clone https://github.com/google/jsonnet
pushd jsonnet
for v in $VERSIONS; do
  git checkout v$v
  make -j4
  mv jsonnet $ROOT/releases/jsonnet-v$v
  make -j4 OPT="-O3 -static"
  mv jsonnet $ROOT/releases/jsonnet.static-v$v
done
popd
gzip releases/*

if [[ -z "$TAG" ]]; then
  echo "No tag given, skipping upload"
  exit 0
fi

./github-release latency-at/jsonnet-releases "$TAG" "master" "Autogenerated" "releases/*"
